{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - {{ empresa.nome }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="{% url 'core:index' %}">{{ empresa.nome }}</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">

        {% if user.is_authenticated %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'core:dashboard' %}">Dashboard</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="{% url 'core:listar_orcamentos' %}">Or√ßamentos</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="{% url 'core:configuracoes' %}">Configura√ß√µes</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="{% url 'core:suporte' %}">Suporte</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="{% url 'core:logout' %}">Sair</a>
          </li>
        {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'core:login' %}">Login</a>
          </li>
        {% endif %}

      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">

  <h2 class="mb-4">Dashboard </h2>

  <!-- Cards principais -->
  <div class="row g-4">
    <div class="col-md-3">
      <div class="card text-white bg-info shadow">
        <div class="card-body">
          <h6>Clientes</h6>
          <h3>{{ clientes }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success shadow">
        <div class="card-body">
          <h6>Produtos</h6>
          <h3>{{ produtos }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning shadow">
        <div class="card-body">
          <h6>Servi√ßos</h6>
          <h3>{{ servicos }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-primary shadow">
        <div class="card-body">
          <h6>Or√ßamentos</h6>
          <h3>{{ orcamentos }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Valor total -->
  <div class="alert alert-secondary mt-4 text-center shadow-sm">
    <strong>Valor total de or√ßamentos:</strong> R$ {{ orcamentos_valor_total|floatformat:2 }}
  </div>

  <!-- üîî Alerta de or√ßamentos pr√≥ximos do vencimento -->
  {% if alerta_orcamentos %}
  <div class="alert alert-danger shadow-sm mt-3">
    <strong>Aten√ß√£o:</strong> Voc√™ possui {{ alerta_orcamentos.count }} or√ßamentos com
    previs√£o de entrega nos pr√≥ximos 3 dias.
    <ul class="mt-2 mb-0">
      {% for orc in alerta_orcamentos %}
        <li>Or√ßamento n¬∫ <strong>{{ orc.numero }}</strong> ‚Äî entrega: {{ orc.previsao_entrega|date:"d/m/Y" }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- Gr√°ficos -->
  <div class="row mt-5">
    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-body">
          <h5 class="card-title text-center">Quantidade de Or√ßamentos por M√™s</h5>
          <canvas id="chartQuantidade"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-body">
          <h5 class="card-title text-center">Valor Total (R$) por M√™s</h5>
          <canvas id="chartValor"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
<footer class="bg-dark text-white text-center py-3 mt-5 fixed-bottom">
  ¬© 2025 {{ empresa.nome }} - Todos os direitos reservados.
</footer>

<script>
  const meses = JSON.parse('{{ meses|escapejs }}');
  const orcamentosMes = JSON.parse('{{ orcamentos_mes|escapejs }}');
  const orcamentosValorMes = JSON.parse('{{ orcamentos_valor_mes|escapejs }}');

  // Gr√°fico de quantidade
  new Chart(document.getElementById('chartQuantidade'), {
    type: 'bar',
    data: {
      labels: meses,
      datasets: [{
        label: 'Or√ßamentos criados',
        data: orcamentosMes,
        backgroundColor: 'rgba(54, 162, 235, 0.7)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });

  // Gr√°fico de valores
  new Chart(document.getElementById('chartValor'), {
    type: 'line',
    data: {
      labels: meses,
      datasets: [{
        label: 'Valor Total (R$)',
        data: orcamentosValorMes,
        borderColor: 'rgba(255, 99, 132, 1)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderWidth: 2,
        fill: true,
        tension: 0.3
      }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });
</script>

</body>
</html>{% load static %}