{% extends "base.html" %}
{% load static %}
{% block content %}

<h2>Orçamento #{{ orcamento.numero }} - {{ orcamento.cliente.razao_social }}</h2>

<p>Previsão entrega: {{ orcamento.previsao_entrega }}</p>
<p>Solicitante: {{ orcamento.solicitante }}</p>
<p>Total: {{ orcamento.total|floatformat:2 }}</p>

<h3>Itens</h3>

<table border="1" width="100%" id="tabelaItens">
    <thead>
        <tr>
            <th>Produto</th>
            <th>Serviço</th>
            <th>Quantidade</th>
            <th>Preço Unit.</th>
            <th>Total</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody>
        {% for item in itens %}
        <tr data-id="{{ item.id }}">
            <td>{{ item.produto.nome if item.produto else "" }}</td>
            <td>{{ item.servico.nome if item.servico else "" }}</td>
            <td>{{ item.quantidade }}</td>
            <td>{{ item.preco_unitario|floatformat:2 }}</td>
            <td>{{ item.total|floatformat:2 }}</td>
            <td>
                <button class="btnEditarItem" data-id="{{ item.id }}">Editar</button>
                <button class="btnExcluirItem" data-id="{{ item.id }}">Excluir</button>
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="6">Nenhum item cadastrado.</td></tr>
        {% endfor %}
    </tbody>
</table>

<button id="btnAdicionarItem">Adicionar Item</button>

<!-- Modal Adicionar/Editar Item -->
<div id="modalItem" style="display:none; background:#eee; padding:20px; border:1px solid #ccc;">
    <form id="formItem">
        {% csrf_token %}
        <input type="hidden" id="itemId" name="itemId" value="">
        <label>Produto:
            <select name="produto" id="produto">
                <option value="">-- Selecione --</option>
                {% for produto in produtos %}
                <option value="{{ produto.id }}">{{ produto.nome }}</option>
                {% endfor %}
            </select>
        </label><br>
        <label>Serviço:
            <select name="servico" id="servico">
                <option value="">-- Selecione --</option>
                {% for servico in servicos %}
                <option value="{{ servico.id }}">{{ servico.nome }}</option>
                {% endfor %}
            </select>
        </label><br>
        <label>Quantidade: <input type="number" name="quantidade" id="quantidade" value="1" min="1"></label><br>
        <label>Preço Unitário: <input type="number" step="0.01" name="preco_unitario" id="preco_unitario"></label><br>
        <button type="submit">Salvar</button>
        <button type="button" id="btnFecharModalItem">Fechar</button>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(function(){

    $("#btnAdicionarItem").click(function(){
        limparFormularioItem();
        $("#modalItem").show();
    });

    $("#btnFecharModalItem").click(function(){
        $("#modalItem").hide();
    });

    $("#formItem").submit(function(e){
        e.preventDefault();
        let itemId = $("#itemId").val();
        let orcamentoId = "{{ orcamento.id }}";
        let url = itemId ? `/core/orcamentos/itens/${itemId}/editar/` : `/core/orcamentos/${orcamentoId}/itens/adicionar/`;

        let data = {
            'produto': $("#produto").val(),
            'servico': $("#servico").val(),
            'quantidade': $("#quantidade").val(),
            'preco_unitario': $("#preco_unitario").val(),
            'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
        };

        $.post(url, data, function(response){
            if(response.status == 'ok'){
                location.reload();
            } else {
                alert('Erro: ' + JSON.stringify(response.erros));
            }
        });
    });

    $(".btnEditarItem").click(function(){
        let id = $(this).data('id');
        $.get(`/core/orcamentos/itens/${id}/`, function(data){
            $("#itemId").val(data.id);
            $("#produto").val(data.produto ? data.produto.id : '');
            $("#servico").val(data.servico ? data.servico.id : '');
            $("#quantidade").val(data.quantidade);
            $("#preco_unitario").val(data.preco_unitario);
            $("#modalItem").show();
        });
    });

    $(".btnExcluirItem").click(function(){
        if(confirm("Confirma exclusão do item?")){
            let id = $(this).data('id');
            $.post(`/core/orcamentos/itens/${id}/excluir/`, {
                'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
            }, function(response){
                if(response.status == 'ok'){
                    location.reload();
                } else {
                    alert("Erro ao excluir.");
                }
            });
        }
    });

    function limparFormularioItem(){
        $("#itemId").val('');
        $("#produto").val('');
        $("#servico").val('');
        $("#quantidade").val(1);
        $("#preco_unitario").val('');
    }
});
</script>

{% endblock %}
