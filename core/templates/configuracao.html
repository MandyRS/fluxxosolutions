{% extends 'base.html' %}

{% block title %}Configuração{% endblock %}

{% block content %}
<h3>Clientes</h3>
<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalCliente">Novo Cliente</button>

<table class="table table-striped" id="tabela-clientes">
    <thead>
        <tr>
            <th>Razão Social</th>
            <th>Nome Fantasia</th>
            <th>CPF/CNPJ</th>
            <th>Telefone</th>
        </tr>
    </thead>
    <tbody>
        {% for cliente in clientes_list %}
        <tr>
            <td>{{ cliente.razao_social }}</td>
            <td>{{ cliente.nome_fantasia }}</td>
            <td>{{ cliente.cpf_cnpj }}</td>
            <td>{{ cliente.telefone }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Modal Cliente -->
<div class="modal fade" id="modalCliente" tabindex="-1" aria-labelledby="modalClienteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formCliente">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% csrf_token %}
                <div class="mb-2"><label>Razão Social</label><input type="text" name="razao_social" class="form-control" required></div>
                <div class="mb-2"><label>Nome Fantasia</label><input type="text" name="nome_fantasia" class="form-control"></div>
                <div class="mb-2"><label>CPF/CNPJ</label><input type="text" name="cpf_cnpj" class="form-control"></div>
                <div class="mb-2"><label>Telefone</label><input type="text" name="telefone" class="form-control"></div>
                <div class="mb-2"><label>Email</label><input type="email" name="email" class="form-control"></div>
                <div class="mb-2"><label>Endereço</label><input type="text" name="endereco" class="form-control"></div>
                <div class="mb-2"><label>Cidade/UF</label><input type="text" name="cidade_uf" class="form-control"></div>
                <div class="mb-2"><label>CEP</label><input type="text" name="cep" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Salvar</button>
            </div>
        </div>
    </form>
  </div>
</div>

<hr>

<h3>Produtos</h3>
<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalProduto">Novo Produto</button>

<table class="table table-striped" id="tabela-produtos">
    <thead>
        <tr>
            <th>Código</th>
            <th>Nome</th>
            <th>Descrição</th>
            <th>Preço</th>
        </tr>
    </thead>
    <tbody>
        {% for produto in produtos_list %}
        <tr>
            <td>{{ produto.codigo }}</td>
            <td>{{ produto.nome }}</td>
            <td>{{ produto.descricao }}</td>
            <td>R$ {{ produto.preco }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Modal Produto -->
<div class="modal fade" id="modalProduto" tabindex="-1" aria-labelledby="modalProdutoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formProduto">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% csrf_token %}
                <div class="mb-2"><label>Código</label><input type="text" name="codigo" class="form-control"></div>
                <div class="mb-2"><label>Nome</label><input type="text" name="nome" class="form-control" required></div>
                <div class="mb-2"><label>Descrição</label><textarea name="descricao" class="form-control"></textarea></div>
                <div class="mb-2"><label>Preço</label><input type="number" name="preco" class="form-control" step="0.01" required></div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Salvar</button>
            </div>
        </div>
    </form>
  </div>
</div>

<hr>

<h3>Serviços</h3>
<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalServico">Novo Serviço</button>

<table class="table table-striped" id="tabela-servicos">
    <thead>
        <tr>
            <th>Código</th>
            <th>Nome</th>
            <th>Descrição</th>
            <th>Preço</th>
        </tr>
    </thead>
    <tbody>
        {% for servico in servicos_list %}
        <tr>
            <td>{{ servico.codigo }}</td>
            <td>{{ servico.nome }}</td>
            <td>{{ servico.descricao }}</td>
            <td>R$ {{ servico.preco }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Modal Serviço -->
<div class="modal fade" id="modalServico" tabindex="-1" aria-labelledby="modalServicoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formServico">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Serviço</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% csrf_token %}
                <div class="mb-2"><label>Código</label><input type="text" name="codigo" class="form-control"></div>
                <div class="mb-2"><label>Nome</label><input type="text" name="nome" class="form-control" required></div>
                <div class="mb-2"><label>Descrição</label><textarea name="descricao" class="form-control"></textarea></div>
                <div class="mb-2"><label>Preço</label><input type="number" name="preco" class="form-control" step="0.01" required></div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Salvar</button>
            </div>
        </div>
    </form>
  </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', () => {
    const csrftoken = getCookie('csrftoken');

    // Cliente AJAX
    document.getElementById('formCliente').addEventListener('submit', function(e){
        e.preventDefault();
        const formData = new FormData(this);

        fetch("{% url 'core:criar_cliente_ajax' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            body: formData
        }).then(res => res.json()).then(data => {
            if(data.status === 'ok'){
                // Atualizar tabela clientes
                const tbody = document.querySelector('#tabela-clientes tbody');
                const c = data.cliente;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${c.razao_social}</td><td>${c.nome_fantasia}</td><td>${c.cpf_cnpj}</td><td>${c.telefone}</td>`;
                tbody.appendChild(tr);
                this.reset();
                var modalEl = document.getElementById('modalCliente');
                var modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
            } else {
                alert(data.mensagem || 'Erro ao criar cliente');
            }
        });
    });

    // Produto AJAX
    document.getElementById('formProduto').addEventListener('submit', function(e){
        e.preventDefault();
        const formData = new FormData(this);

        fetch("{% url 'core:criar_produto_ajax' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            body: formData
        }).then(res => res.json()).then(data => {
            if(data.status === 'ok'){
                const tbody = document.querySelector('#tabela-produtos tbody');
                const p = data.produto;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${p.codigo}</td><td>${p.nome}</td><td>${p.descricao}</td><td>R$ ${p.preco}</td>`;
                tbody.appendChild(tr);
                this.reset();
                var modalEl = document.getElementById('modalProduto');
                var modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
            } else {
                alert(data.mensagem || 'Erro ao criar produto');
            }
        });
    });

    // Serviço AJAX
    document.getElementById('formServico').addEventListener('submit', function(e){
        e.preventDefault();
        const formData = new FormData(this);

        fetch("{% url 'core:criar_servico_ajax' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            body: formData
        }).then(res => res.json()).then(data => {
            if(data.status === 'ok'){
                const tbody = document.querySelector('#tabela-servicos tbody');
                const s = data.servico;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${s.codigo}</td><td>${s.nome}</td><td>${s.descricao}</td><td>R$ ${s.preco}</td>`;
                tbody.appendChild(tr);
                this.reset();
                var modalEl = document.getElementById('modalServico');
                var modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
            } else {
                alert(data.mensagem || 'Erro ao criar serviço');
            }
        });
    });
});
</script>

{% endblock %}
