{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Configurações - {{ empresa.nome }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="{% url 'core:index' %}"> {{ empresa.nome}}</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        {% if user.is_authenticated %}
          <li class="nav-item"><a class="nav-link" href="{% url 'core:dashboard' %}">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'core:listar_orcamentos' %}">Orçamentos</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'core:configuracoes' %}">Configurações</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'core:suporte' %}">Suporte</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'core:logout' %}">Sair</a></li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="{% url 'core:login' %}">Login</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h2>Configurações</h2>

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" id="configTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="clientes-tab" data-bs-toggle="tab" data-bs-target="#clientes" type="button" role="tab">Clientes</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos" type="button" role="tab">Produtos</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="servicos-tab" data-bs-toggle="tab" data-bs-target="#servicos" type="button" role="tab">Serviços</button>
    </li>
  </ul>

  <div class="tab-content mt-3" id="configTabsContent">
    <!-- Clientes -->
    <div class="tab-pane fade show active" id="clientes" role="tabpanel">
      <button class="btn btn-primary mb-3" id="btn-novo-cliente" data-bs-toggle="modal" data-bs-target="#modalCliente">Novo Cliente</button>
      <table class="table table-striped" id="tabela-clientes">
          <thead>
              <tr>
                  <th>Razão Social</th>
                  <th>Nome Fantasia</th>
                  <th>CPF/CNPJ</th>
                  <th>Telefone</th>
                  <th>Ações</th>
              </tr>
          </thead>
          <tbody>
              {% for cliente in clientes_list %}
              <tr>
                  <td>{{ cliente.razao_social }}</td>
                  <td>{{ cliente.nome_fantasia }}</td>
                  <td>{{ cliente.cpf_cnpj }}</td>
                  <td>{{ cliente.telefone }}</td>
                  <td>
                      <button class="btn btn-sm btn-info btn-editar-cliente" data-id="{{ cliente.id }}" data-bs-toggle="modal" data-bs-target="#modalCliente">Editar</button>
                      <button class="btn btn-sm btn-danger btn-excluir-cliente" data-id="{{ cliente.id }}">Excluir</button>
                  </td>
              </tr>
              {% endfor %}
          </tbody>
      </table>
    </div>

    <!-- Produtos -->
    <div class="tab-pane fade" id="produtos" role="tabpanel">
      <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalProduto">Novo Produto</button>
      <table class="table table-striped" id="tabela-produtos">
          <thead>
              <tr><th>Código</th><th>Nome</th><th>Descrição</th><th>Preço</th><th>Ações</th></tr>
          </thead>
          <tbody>
            {% for produto in produtos_list %}
            <tr>
                <td>{{ produto.codigo }}</td>
                <td>{{ produto.nome }}</td>
                <td>{{ produto.descricao }}</td>
                <td>R$ {{ produto.preco }}</td>
                <td>
                    <button class="btn btn-sm btn-info btn-editar-produto" data-id="{{ produto.id }}" data-bs-toggle="modal" data-bs-target="#modalProduto">Editar</button>
                    <button class="btn btn-sm btn-danger btn-excluir-produto" data-id="{{ produto.id }}">Excluir</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Serviços -->
    <div class="tab-pane fade" id="servicos" role="tabpanel">
      <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalServico">Novo Serviço</button>
      <table class="table table-striped" id="tabela-servicos">
          <thead>
              <tr><th>Código</th><th>Nome</th><th>Descrição</th><th>Preço</th><th>Ações</th></tr>
          </thead>
          <tbody>
              {% for servico in servicos_list %}
              <tr>
                  <td>{{ servico.codigo }}</td>
                  <td>{{ servico.nome }}</td>
                  <td>{{ servico.descricao }}</td>
                  <td>R$ {{ servico.preco }}</td>
                  <td>
                      <button class="btn btn-sm btn-info btn-editar-servico" data-id="{{ servico.id }}" data-bs-toggle="modal" data-bs-target="#modalServico">Editar</button>
                      <button class="btn btn-sm btn-danger btn-excluir-servico" data-id="{{ servico.id }}">Excluir</button>
                  </td>
              </tr>
              {% endfor %}
          </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Cliente -->
<div class="modal fade" id="modalCliente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formCliente">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cliente-id" name="id">
                {% csrf_token %}
                <div class="mb-2"><label>Razão Social</label><input type="text" name="razao_social" class="form-control" required></div>
                <div class="mb-2"><label>Nome Fantasia</label><input type="text" name="nome_fantasia" class="form-control"></div>
                <div class="mb-2"><label>CPF/CNPJ</label><input type="text" name="cpf_cnpj" class="form-control"></div>
                <div class="mb-2"><label>Telefone</label><input type="text" name="telefone" class="form-control"></div>
                <div class="mb-2"><label>Email</label><input type="email" name="email" class="form-control"></div>
                <div class="mb-2"><label>Endereço</label><input type="text" name="endereco" class="form-control"></div>
                <div class="mb-2"><label>Cidade/UF</label><input type="text" name="cidade_uf" class="form-control"></div>
                <div class="mb-2"><label>CEP</label><input type="text" name="cep" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Salvar</button>
            </div>
        </div>
    </form>
  </div>
</div>

<!-- Modal Produto -->
<div class="modal fade" id="modalProduto" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formProduto">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="produto-id" name="id">
                {% csrf_token %}
                <div class="mb-2"><label>Código</label><input type="text" name="codigo" class="form-control"></div>
                <div class="mb-2"><label>Nome</label><input type="text" name="nome" class="form-control"></div>
                <div class="mb-2"><label>Descrição</label><input type="text" name="descricao" class="form-control"></div>
                <div class="mb-2"><label>Preço</label><input type="number" step="0.01" name="preco" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Salvar</button>
            </div>
        </div>
    </form>
  </div>
</div>

<!-- Modal Serviço -->
<div class="modal fade" id="modalServico" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formServico">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Serviço</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="servico-id" name="id">
                {% csrf_token %}
                <div class="mb-2"><label>Código</label><input type="text" name="codigo" class="form-control"></div>
                <div class="mb-2"><label>Nome</label><input type="text" name="nome" class="form-control"></div>
                <div class="mb-2"><label>Descrição</label><input type="text" name="descricao" class="form-control"></div>
                <div class="mb-2"><label>Preço</label><input type="number" step="0.01" name="preco" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Salvar</button>
            </div>
        </div>
    </form>
  </div>
</div>

<footer class="bg-dark text-white text-center py-3 mt-5 fixed-bottom">
  © 2025 {{ empresa.nome }} - Todos os direitos reservados.
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// ======================= AJAX e Modals ========================
$(document).ready(function(){

    // Abrir modal novo cliente
    $('#btn-novo-cliente').click(function(){
        $('#formCliente')[0].reset();
        $('#cliente-id').val('');
        $('.modal-title').text('Novo Cliente');
    });

    // Função genérica: abrir modal de edição
    function abrirModalEdicao(tipo, id) {
        const modalId = tipo === 'clientes' ? '#modalCliente' :
                        tipo === 'produtos' ? '#modalProduto' : '#modalServico';
        $.ajax({
            url: `/${tipo}/${id}/editar/`,
            type: 'GET',
            success: function(data){
                const form = $(modalId + ' form')[0];
                form.reset();
                for (let key in data) {
                    $(modalId + ` [name="${key}"]`).val(data[key]);
                }
                $('.modal-title').text('Editar ' + tipo.slice(0,-1));
                bootstrap.Modal.getOrCreateInstance(document.getElementById(modalId.slice(1))).show();
            },
            error: function(xhr){
                alert(`Erro ao carregar ${tipo.slice(0,-1)}: ${xhr.responseText}`);
            }
        });
    }

    $(document).on('click', '.btn-editar-cliente', function(){ abrirModalEdicao('clientes', $(this).data('id')); });
    $(document).on('click', '.btn-editar-produto', function(){ abrirModalEdicao('produtos', $(this).data('id')); });
    $(document).on('click', '.btn-editar-servico', function(){ abrirModalEdicao('servicos', $(this).data('id')); });

    // Função genérica: excluir
    $(document).on('click', '.btn-excluir-cliente, .btn-excluir-produto, .btn-excluir-servico', function(){
        const id = $(this).data('id');
        const linha = $(this).closest('tr');
        const tipo = $(this).hasClass('btn-excluir-cliente') ? 'clientes' :
                     $(this).hasClass('btn-excluir-produto') ? 'produtos' : 'servicos';

        if(confirm(`Deseja realmente excluir este ${tipo.slice(0,-1)}?`)){
            $.ajax({
                url: `/${tipo}/${id}/excluir/`,
                type: 'POST',
                headers: {'X-CSRFToken': csrftoken},
                success: function(resp){
                    if(resp.status === 'ok') linha.fadeOut();
                    else alert(resp.mensagem);
                },
                error: function(xhr){ alert(`Erro ao excluir ${tipo.slice(0,-1)}: ${xhr.responseText}`); }
            });
        }
    });

    // Função genérica: salvar novo/editar
    $('#formCliente, #formProduto, #formServico').submit(function(e){
        e.preventDefault();
        const form = this;
        const tipo = $(form).attr('id') === 'formCliente' ? 'clientes' :
                     $(form).attr('id') === 'formProduto' ? 'produtos' : 'servicos';
        const id = $(form).find('input[name="id"]').val();
        const url = id ? `/${tipo}/${id}/editar/` : `/${tipo}/criar/`;
        const formData = new FormData(form);

        fetch(url, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            body: formData
        }).then(res => res.json())
        .then(data => {
            if(data.status === 'ok'){
                location.reload(); // atualiza a tabela
            } else { alert(data.mensagem || 'Erro ao salvar'); }
        }).catch(err => console.log(err));
    });
});
</script>
</body>
</html>
